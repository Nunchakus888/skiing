# 滑雪照片水印去除工具

自动去除滑雪照片中的"滑呗app"等水印文字。支持三种检测模式，从基础到AI混合，满足不同需求。

## 🚀 快速开始

### 最简单的方式
```bash
./run.sh
```

选择 **7（混合模式）** 或 **9（预览）** ⭐推荐首选

### 手动运行
```bash
source skiing/bin/activate
python remove_watermark_opencv.py
```

## 🎯 三种模式对比

| 模式 | 优势 | 适用场景 | 速度 |
|------|------|----------|------|
| **基础模式** (1-3) | 快速、轻量级 | 简单明显的水印 | ⚡⚡⚡ |
| **OCR模式** (4-6) | 精确识别文字 | 清晰的文字水印 | ⚡⚡ |
| **混合模式⭐** (7-9) | 最全面、支持艺术字 | **推荐首选** | ⚡ |

## 📋 功能选项

运行后选择对应数字：

### 基础模式（1-3）
- **1** - 处理单张图片
- **2** - 批量处理
- **3** - 预览检测效果

### OCR 模式（4-6）
- **4** - 处理单张图片（识别特定文字 + 特定颜色）
- **5** - 批量处理
- **6** - 预览识别效果

**颜色检测**: 自动检测 #67789d 和 #5e7da8（蓝灰色水印）

### 混合模式⭐（7-9）推荐
- **7** - 处理单张图片（最全面）
- **8** - 批量处理（OCR + 颜色 + 模式检测）
- **9** - 预览三层检测效果

## 💡 使用建议

### 首次使用
```bash
./run.sh
# 选择 6 - OCR 预览模式（查看颜色+文字检测）
# 满意后选择 4 - 处理单张图片
# 或选择 5 - 批量处理所有图片
```

### 如何选择模式？
- **推荐首选**: 选择 **4** 或 **5** (OCR + 颜色检测) - 针对特定水印颜色优化
- **最全面**: 选择 **7** 或 **8** (混合模式) - 包含所有检测方法
- **快速处理**: 选择 **1** 或 **2** (基础模式) - 速度快

## 🔧 技术特点

### 混合模式三层检测
1. **OCR 文字识别** - 识别清晰的水印文字
2. **颜色特征检测** - 检测浅色/灰色半透明水印
3. **重复模式检测** - 识别艺术字和重复图案

### 智能修复策略
- 根据水印覆盖率自动调整修复半径
- < 1%: 精细修复（半径7）
- 1-5%: 标准修复（半径5）
- \> 5%: 保守修复（半径3）避免模糊

### 可检测的水印特征
- **关键词**: 滑呗、app、BDH、1000万、雪友、选择、雪票、酒店、教练、摄影师、约玩
- **特定颜色**: #67789d 和 #5e7da8（蓝灰色水印，OCR模式自动检测）
- **模式特征**: 半透明、重复图案（混合模式）

可编辑脚本 `watermark_patterns` 添加自定义关键词。

## 📦 环境配置

### 已完成✓
```bash
# 虚拟环境：skiing
# 包管理器：uv
# 已安装依赖：opencv-python, numpy, Pillow, easyocr
```

### 如需重新安装
```bash
# 删除旧环境
rm -rf skiing

# 创建新环境
uv venv skiing

# 安装依赖
source skiing/bin/activate
uv pip install opencv-python numpy Pillow requests easyocr
```

## 📊 输出说明

### 文件命名
- 基础模式: `*_cleaned.JPG`
- OCR模式: `*_ocr.JPG`
- 混合模式: `*_hybrid.JPG`

### 批量处理输出目录
```
images/
├── cleaned/         # 基础模式
├── cleaned_ocr/     # OCR模式
└── cleaned_hybrid/  # 混合模式
```

## 🛠️ 故障排除

### OCR 模块报错
```bash
source skiing/bin/activate
uv pip install easyocr torch torchvision
```

### 首次使用 OCR/混合模式很慢
- 正常现象，需下载模型（约100MB）
- 下载后会缓存，之后就快了

### 检测范围过大
- 使用 OCR 模式（选项4-6）更精确
- 或先用预览模式（3/6/9）查看效果

## 📈 性能参考

| 模式 | 单张耗时 | 检测准确率 |
|------|----------|------------|
| 基础 | 1-2秒 | 70% |
| OCR | 5-10秒 | 85% |
| 混合⭐ | 8-15秒 | **95%** |

## 🎓 最佳实践

### 高质量处理
```bash
./run.sh → 9（预览） → 7（处理）
```

### 快速批量
```bash
./run.sh → 8（混合批量）或 2（基础批量）
```

### 自定义关键词
编辑 `remove_watermark_opencv.py` 添加你的水印关键词：
```python
watermark_patterns = [
    r'滑呗', r'app',
    r'你的关键词',  # 添加这里
]
```

## 📁 项目结构

```
.
├── README.md                      # 本文档
├── pyproject.toml                 # uv 项目配置
├── remove_watermark_opencv.py     # 主程序（混合模式）
├── run.sh                         # 一键启动脚本
├── download_images.py             # 图片下载脚本
├── skiing/                        # 虚拟环境
└── images/                        # 图片目录
```

## 💬 提示

- **推荐首选**: 混合模式（选项7/8/9）
- **预览先行**: 首次使用建议先预览检测效果
- **离线可用**: 模型下载后可完全离线使用
- **批量处理**: 支持一键处理文件夹所有图片

